<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🚌 Student Bus Tracker Dashboard</title>
    <style>
        :root {
            --primary-color: #3f51b5; /* Indigo */
            --secondary-color: #ff9800; /* Orange */
            --background-light: #f4f6f9;
            --card-background: #ffffff;
            --text-dark: #212121;
            --text-medium: #616161;
            --border-color: #e0e0e0;
        }

        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-light);
            color: var(--text-dark);
            min-height: 100vh;
        }

        .background-container {
            /* This is kept, but we rely on the body background */
            display: none; 
        }

        #busListModal {
            display: block !important;
            padding: 20px;
            max-width: 90%;
            margin: 0 auto;
        }
        
        #busListContainer {
            background-color: var(--card-background);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 20px 0;
        }

        h1 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 20px;
            font-size: 2.2rem;
            border-bottom: 3px solid var(--secondary-color);
            padding-bottom: 10px;
        }

        h2 {
            color: var(--text-dark);
            margin: 0 20px 15px 20px;
            font-size: 1.5rem;
            padding-top: 10px;
        }

        #searchContainer {
            padding: 0 20px 15px 20px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 10px;
        }

        #routeSearch {
            width: 100%; /* Full width for the search bar */
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }

        #routeSearch:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        #busCards {
            padding: 0 20px; /* Padding for the container */
            display: flex;
            flex-direction: column;
            gap: 15px; /* Space between cards */
        }

        /* Bus Card Styling - Made Full Width */
        .bus-card {
            cursor: pointer;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            width: 100%; /* Ensures full width within its padded container */
            box-sizing: border-box;
        }

        .bus-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-color);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px dashed var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 10px;
        }

        .card-header strong {
            font-size: 1.2rem;
            color: var(--primary-color);
        }

        .bus-number {
            font-weight: 700;
            color: var(--secondary-color);
            background-color: #fff3e0;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .card-route-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-bottom: 10px;
        }

        .route-stop {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .route-stop-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 3px;
        }

        .circle {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--primary-color);
            border: 2px solid var(--card-background);
        }
        
        .start-stop .circle {
            background-color: #4caf50; /* Green for start */
        }
        
        .end-stop .circle {
            background-color: #f44336; /* Red for end */
        }

        .line {
            width: 2px;
            background-color: var(--border-color);
        }

        .route-details {
            display: flex;
            justify-content: space-between;
            width: 100%;
            font-size: 1.05rem;
        }

        .route-details .time {
            font-weight: 500;
            color: var(--text-medium);
        }

        .stops-count {
            color: var(--text-medium);
            font-size: 0.9rem;
            padding: 5px 0;
            margin-left: 30px !important; /* Align with route details */
        }

        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 10px;
            border-top: 1px dashed var(--border-color);
            color: var(--text-medium);
            font-size: 0.95rem;
        }

        .bus-type {
            background-color: var(--primary-color);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
            font-size: 0.85rem;
        }
    </style>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

</head>
<body>

<div id="busListModal">
    <h1>🎓 Student Bus Tracker Dashboard</h1>
    <div id="busListContainer">
        <h2>🚌 Select Your Active Route</h2>
        
        <div id="searchContainer">
            <input type="text" id="routeSearch" placeholder="🔍 Search by bus or route name..." onkeyup="searchCards()">
        </div>

        <div style="padding: 10px 20px 0 20px; color: var(--text-medium); font-size: 0.9rem;">
            All active trips (Click to track in real-time)
        </div>

        <div id="busCards">
            <p style='text-align:center; padding:20px; color:var(--text-medium);'>Loading active routes...</p>
        </div>
    </div>
</div>

<script>
// Firebase setup
// NOTE: I'm keeping your original config. For testing without a real database,
// you would mock the 'db.ref().once()' call.
const firebaseConfig = {
    apiKey: "AIzaSyCYYUoSTCBRAZ7DRctIKPkXN-4FZrmmG0s",
    authDomain: "vijay-6727f.firebaseapp.com",
    databaseURL: "https://vijay-6727f-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "vijay-6727f",
    storageBucket: "vijay-6727f.appspot.com",
    messagingSenderId: "68450066325",
    appId: "1:68450066325:web:e6ce31fde1ee5e55b7e09c"
};
// Check if Firebase is already initialized to prevent errors in development
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}
const db = firebase.database();

// --- TEST DATA FOR DEMO/DEVELOPMENT ---
// This is to ensure the page displays content even if Firebase is unavailable.
// You should remove this block once you're sure your Firebase connection is working.
const mockBusData = {
    "Trip001": { 
        "busId": "B-101", "isActive": true, "stopsCount": 12, "departureTime": "07:00 AM", 
        "arrivalTime": "08:30 AM", "busType": "AC", "startStop": "Main Campus Gate", 
        "endStop": "Student Hostel", "duration": "1 hr 30 min", "route": "Campus—Hostel"
    },
    "Trip002": { 
        "busId": "B-205", "isActive": true, "stopsCount": 8, "departureTime": "07:30 AM", 
        "arrivalTime": "08:15 AM", "busType": "STANDARD", "startStop": "City Central Depot", 
        "endStop": "Science Block", "duration": "45 min", "route": "City—Campus"
    },
    "Trip003": { 
        "busId": "B-303", "isActive": true, "stopsCount": 5, "departureTime": "06:45 AM", 
        "arrivalTime": "07:15 AM", "busType": "EXPRESS", "startStop": "North Residential Area", 
        "endStop": "Library Annex", "duration": "30 min", "route": "North—Library"
    },
    "Trip004": {
        "busId": "B-999", "isActive": false, "stopsCount": 10, "departureTime": "09:00 AM",
        "arrivalTime": "10:00 AM", "busType": "STANDARD", "startStop": "Dormitory 4",
        "endStop": "Sports Complex", "duration": "1 hr", "route": "Dorm—Sports"
    }
};

/**
 * Searches the bus cards based on user input.
 */
function searchCards() {
    const filter = document.getElementById('routeSearch').value.toUpperCase();
    const cards = document.getElementById('busCards').getElementsByClassName('bus-card');
    let visibleCardCount = 0;
    
    for (let i = 0; i < cards.length; i++) {
        // Get the searchable text (Bus ID, Start Stop, End Stop)
        // Note: The structure changed slightly, updating selectors for reliability
        const card = cards[i];
        const busIdText = card.querySelector('.bus-number').textContent || "";
        const startStopText = card.querySelector('.route-stop.start-stop .route-details span:first-child').textContent || "";
        const endStopText = card.querySelector('.route-stop.end-stop .route-details span:first-child').textContent || "";
        
        const searchableText = (busIdText + " " + startStopText + " " + endStopText).toUpperCase();

        if (searchableText.indexOf(filter) > -1) {
            card.style.display = "flex"; // Show the card (using flex for card layout)
            visibleCardCount++;
        } else {
            card.style.display = "none"; // Hide the card
        }
    }
    
    // Display a message if no buses match the search
    const noResults = document.getElementById('no-search-results');
    if (visibleCardCount === 0 && cards.length > 0) {
        if (!noResults) {
            document.getElementById('busCards').insertAdjacentHTML('beforeend', "<p id='no-search-results' style='text-align:center; padding:20px; color:#f44336;'>No routes found matching your search term.</p>");
        } else {
            noResults.style.display = 'block';
        }
    } else if (noResults) {
        noResults.style.display = 'none';
    }
}

/**
 * Handles bus selection and navigates to the tracker page.
 * @param {string} busId - The ID of the selected bus (Firebase key).
 */
function selectBus(busId) {
    // Navigate to the tracker page and pass the busId as a query parameter
    window.location.href = `tracker.html?busId=${busId}`;
}

/**
 * Creates the HTML card for a single bus trip.
 * @param {object} trip - The trip data from Firebase.
 * @param {string} busId - The Firebase key for the trip.
 * @returns {HTMLElement} The created bus card element.
 */
function createBusCard(trip, busId) {
    // Use trip data or display 'N/A' if the field is missing
    const stopsCount = trip.stopsCount || 'N/A';
    const departureTime = trip.departureTime || 'N/A';
    const arrivalTime = trip.arrivalTime || 'N/A';
    const busType = trip.busType || 'STANDARD';
    const routeParts = trip.route ? trip.route.split('—').map(s => s.trim()) : [];
    const startStopName = trip.startStop || routeParts[0] || 'Source N/A';
    const endStopName = trip.endStop || routeParts[1] || 'Destination N/A';
    const duration = trip.duration || 'N/A';
    const busDisplayName = trip.busId || 'BUS N/A';
    
    const card = document.createElement('div');
    card.className = 'bus-card';
    card.dataset.busId = busId;
    
    // Set display style to flex for modern card layout
    card.style.display = 'flex'; 
    card.style.flexDirection = 'column';

    card.innerHTML = `
        <div class="card-header">
            <div style="display:flex; align-items:center; gap:5px;">
                <span style="font-size:1.5rem;">&#128652;</span>
                <strong>${busDisplayName}</strong>
            </div>
            <span class="bus-number">${busId.toUpperCase()}</span>
        </div>
        <div class="card-route-info">
            <div class="route-stop start-stop">
                <div class="route-stop-icon">
                    <div class="circle"></div>
                    <div class="line" style="height: 35px;"></div>
                </div>
                <div class="route-details">
                    <span>${startStopName}</span>
                    <span class="time">${departureTime}</span>
                </div>
            </div>
            ${stopsCount !== 'N/A' ? `<div class="stops-count">Intermediate Stops: ${stopsCount}</div>` : ''}
            <div class="route-stop end-stop">
                <div class="route-stop-icon">
                    <div class="circle"></div>
                </div>
                <div class="route-details">
                    <span>${endStopName}</span>
                    <span class="time">${arrivalTime}</span>
                </div>
            </div>
        </div>
        <div class="card-footer">
            <span style="display:flex; align-items:center; gap:5px;">
                <span style="font-size:1rem;">&#9201;</span>
                Travel Time: ${duration}
            </span>
            <span class="bus-type">${busType}</span>
        </div>
    `;
    
    card.addEventListener('click', function() {
        selectBus(busId);
    });

    return card;
}


/**
 * Fetches active bus list from Firebase and populates the cards.
 */
function loadBusList() {
    const busCardsContainer = document.getElementById('busCards');
    busCardsContainer.innerHTML = "<p style='text-align:center; padding:20px; color:var(--text-medium);'>Fetching live data...</p>";

    // Function to handle the snapshot data (used by both live and mock data)
    const processSnapshot = (data) => {
        busCardsContainer.innerHTML = ''; // Clear status message
        let activeBusCount = 0;

        // Iterate over the data (which is a JSON object from a snapshot or mock data)
        for (const busId in data) {
            const trip = data[busId];
            if (trip.isActive) {
                const card = createBusCard(trip, busId);
                busCardsContainer.appendChild(card);
                activeBusCount++;
            }
        }

        if (activeBusCount === 0) {
            busCardsContainer.innerHTML = "<p style='text-align:center; padding:20px; color:var(--text-medium);'>✅ No active buses found at this time. Check back later!</p>";
        }
        
        // Attach search listener after cards are populated
        document.getElementById('routeSearch').addEventListener('keyup', searchCards);
    };

    // Attempt to fetch from Firebase
    db.ref('Trips').orderByChild('isActive').equalTo(true).once('value')
        .then(snapshot => {
            if (snapshot.exists()) {
                // If live data exists, process it
                processSnapshot(snapshot.val());
            } else {
                // If no live data, use mock data for testing/demo (filter isActive=true)
                console.warn("No live data found, loading test data.");
                const activeMockData = {};
                for (const key in mockBusData) {
                    if (mockBusData[key].isActive) {
                        activeMockData[key] = mockBusData[key];
                    }
                }
                processSnapshot(activeMockData);
            }
        })
        .catch(error => {
            console.error("Error loading bus list from Firebase, falling back to test data:", error);
            // Fallback to test data on error
            const activeMockData = {};
            for (const key in mockBusData) {
                if (mockBusData[key].isActive) {
                    activeMockData[key] = mockBusData[key];
                }
            }
            processSnapshot(activeMockData);
            // You might want to show a more explicit error to the user if the fallback is not desired
            // busCardsContainer.innerHTML = "<p style='text-align:center; padding:20px; color:red;'>Failed to load bus list. Check connection.</p>";
        });
}

document.addEventListener('DOMContentLoaded', loadBusList);
</script>

</body>
</html>